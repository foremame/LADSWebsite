<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script type="text/javascript" th:src="@{/js/CommonMethods.js}"></script>
</head>
<body>
<div class="container">
    <div th:if="${numCards}" class="success-message">
        <p th:text="${numCards == 1} ? ${numCards} + ' card added to pull tracker!' : ${numCards} + ' cards added to pull tracker!'"></p>
    </div>
    <div th:if="${errorMsg}" class="error-message">
        <p th:text="${errorMsg}"></p>
    </div>
    <div id="errorDiv" style="display:none">
    </div>
    <form name="cardPullForm" action="/cardPull/add" method="post">
        <div class="form-group" id="bannerList">
            <label for="bannerNameSearch">Banner:</label>
            <input type="text" id="bannerNameSearch" onkeyup="searchForName('bannerNameSearch','bannersUL')" placeholder="Search for banner name..">
            <ul id="bannersUL">
                <li th:each="banner: ${banners}" style="display:none">
                    <input type="radio" th:id="${'Banner' + banner.id}" name="bannerId" th:value="${banner.id}">
                    <label th:for="${'Banner' + banner.id}" th:text="${banner.name}"></label>
                </li>
            </ul>
        </div>
        <div class="form-group" id="pullTimestampDiv" style="display:none">
            <label for="pullTimestamp">Pull Timestamp (YYYY-MM-DD HH:MM:SS):</label>
            <input type="text" id="pullTimestamp" name="pullTimestamp" placeholder="Enter pull timestamp here...">
        </div>
        <div class="form-group" id="pullTypeDiv" style="display:none">
            <ul id="pullTypeUL">
                <li>
                    <label for="singlePull">Single Pull:</label>
                    <input type="radio" id="singlePull" name="multipleCardPulls" value="false">
                </li>
                <li>
                    <label for="10Pull">10 Pull:</label>
                    <input type="radio" id="10Pull" name="multipleCardPulls" value="true">
                </li>
            </ul>
        </div>
        <div class="form-group" id="cardList[0]" style="display:none">
            <label for="cardNameSearch[0]">Card Pulled:</label>
            <input type="text" id="cardNameSearch[0]" onkeyup="searchForNameLimited(0)" placeholder="Search for card name..">
            <ul id="cardsUL[0]">
                <li th:each="standardCard: ${standardCards}" style="display:none">
                    <input type="radio" th:id="${standardCard.id + 'Standard[0]'}" name="cardPulls[0].cardId" th:value="${standardCard.id}" onchange="cardRadioInputChange(this.value, 0)">
                    <label th:for="${standardCard.id + 'Standard[0]'}" th:text="${standardCard.name}"></label>
                </li>
                <li th:each="limitedCard: ${limitedCards}" style="display:none">
                    <input type="radio" th:id="${limitedCard.id + 'Limited[0]'}" name="cardPulls[0].cardId" th:value="${limitedCard.id}" onchange="cardRadioInputChange(this.value, 0)">
                    <label th:for="${limitedCard.id + 'Limited[0]'}" th:text="${limitedCard.name}"></label>
                </li>
            </ul>
        </div>
        <div class="form-group" id="preciseWishDiv[0]" style="display:none">
            <input id="preciseWish[0]" name="cardPulls[0].preciseWish" type="checkbox" />
            <label for="preciseWish[0]">Precise Wish</label>
        </div>
        <div th:each="i : ${#numbers.sequence( 1, 9, 1)}" th:id="${i + 'cardPullsMultiple'}" style="display:none">
            <div class="form-group" th:id="${'cardList[' + i + ']'}" style="display:none">
                <label th:for="${'cardNameSearch[' + i + ']'}">Card Pulled:</label>
                <input type="text" th:id="${'cardNameSearch[' + i + ']'}" th:attr="onkeyup=|searchForNameLimited('${i}')|" placeholder="Search for card name..">
                <ul th:id="${'cardsUL[' + i + ']'}">
                    <li th:each="standardCard: ${standardCards}" style="display:none">
                        <input type="radio" th:id="${standardCard.id + 'Standard[' + i + ']'}" th:name="${'cardPulls[' + i + '].cardId'}" th:value="${standardCard.id}" th:attr="onchange=|cardRadioInputChange(this.value,'${i}')|">
                        <label th:for="${standardCard.id + 'Standard[' + i + ']'}" th:text="${standardCard.name}"></label>
                    </li>
                    <li th:each="limitedCard: ${limitedCards}" style="display:none">
                        <input type="radio" th:id="${limitedCard.id + 'Limited[' + i + ']'}" th:name="${'cardPulls[' + i + '].cardId'}" th:value="${limitedCard.id}" th:attr="onchange=|cardRadioInputChange(this.value,'${i}')|">
                        <label th:for="${limitedCard.id + 'Limited[' + i + ']'}" th:text="${limitedCard.name}"></label>
                    </li>
                </ul>
            </div>
            <div class="form-group" th:id="${'preciseWishDiv[' + i +']'}" style="display:none">
                <input th:id="${'preciseWish[' + i +']'}" th:name="${'cardPulls[' + i +'].preciseWish'}" type="checkbox" />
                <label th:for="${'preciseWish[' + i +']'}">Precise Wish</label>
            </div>
        </div>
        <div id="submitButtonDiv" style="display:none">
            <button class="submit" type="submit">Submit</button>
        </div>
    </form>
</div>
<script th:inline="javascript" type="text/javascript">

    var limitedIds = [];
    var isMulti = false;
    const checkedCards = new Map();

    document.addEventListener('DOMContentLoaded', function() {
        var bannerId = /*[[${bannerId}]]*/;
        if (bannerId) {
            url_post("/cardPull/getLimitedCardIds", {"bannerId" : bannerId}).done( function(msg) {
                var ids = JSON.parse(msg);
                limitedIds = ids;
            });
            url_post("/banner/isMulti", {"id" : bannerId}).done( function(msg) {
                isMulti = JSON.parse(msg);
            });
            var bannerRadio = $('#Banner' + bannerId)[0];
            $('#bannerNameSearch').val(bannerRadio.labels[0].textContent);
            bannerRadio.checked = true;
            bannerRadio.parentElement.style.display = "";
            var date = /*[[${date}]]*/;
            var time = /*[[${time}]]*/;
            $('#pullTimestamp').val(date + " " + time);
            $('#pullTimestampDiv').show();
            $('#pullTypeDiv').show();
            $('#submitButtonDiv').show();
        }
    }, false);

    $("form").submit( function(e) {
        // The rest of the validation is handled when the form is submitted by the controller.
        e.preventDefault();
        $("#errorDiv").hide();
        $("#errorDiv").empty();

        var form = this;
        var issue = false
        var errorText = "";

        if ($("input[name='multipleCardPulls']:checked").val() == "true") {
            for (var i = 0; i < 10; i++) {
                var checkedVal = $("input[name='cardPulls\\[" + i + "\\].cardId']:checked").val();
                if (!checkedVal) {
                    issue = true;
                    var number = i + 1;
                    errorText += "<p>Card " + number + " is not selected.</p>";
                }
            }
        }
        else {
            var checkedVal = $("input[name='cardPulls\\[0\\].cardId']:checked").val();
            if (!checkedVal) {
                issue = true;
                errorText += "<p>Please select a card.</p>";
            }
        }

        if (issue == true) {
            $("#errorDiv").append(errorText);
            $("#errorDiv").show();
        }
        else {
            form.submit();
        }
    });

    $("input[name='bannerId']").change(function(){
        url_post("/cardPull/getLimitedCardIds", {"bannerId" : $(this).val()}).done( function(msg) {
            var ids = JSON.parse(msg);
            limitedIds = ids;
        });
        url_post("/banner/isMulti", {"id" : $(this).val()}).done( function(msg) {
            isMulti = JSON.parse(msg);
        });
        uncheckCards();
        $('#pullTimestampDiv').show();
        $('#pullTypeDiv').show();
        $('#submitButtonDiv').show();
    });

    function uncheckCards() {
        for (var j = 0; j < 10; j++) {
            if (checkedCards.has(j)) {
                document.getElementById('cardNameSearch[' + j + ']').value = "";
                var radioEle = $('#' + checkedCards.get(j) + 'Limited\\[' + j + '\\]');
                var radio;
                // If checked element is limited or standard, it will have a different id value
                if (radioEle.length == 1) {
                    radio = radioEle[0];
                }
                else {
                    radio = $('#' + checkedCards.get(j) + 'Standard\\[' + j + '\\]')[0];
                }
                radio.checked = false;
                radio.parentElement.style.display = "none";
                var preciseWishName = "'cardPulls[" + j + "].preciseWish'"
                var checkbox = $("[name=" + preciseWishName + "]");
                checkbox[0].parentElement.style.display = "none";
                checkbox[0].checked = false;
            }
        }
        checkedCards.clear();
    }

    $("input[name='multipleCardPulls']").change( function() {
        var multiple = $(this).val();
        $('#cardList\\[0\\]').show();
        if (multiple == "true") {
            for (var i = 1; i < 10; i++) {
                $('#' + i + 'cardPullsMultiple').show();
                $('#cardList\\[' + i + '\\]').show();
            }
        }
        else {
            for (var i = 1; i < 10; i++) {
                $('#' + i + 'cardPullsMultiple').hide();
                $('#cardList\\[' + i + '\\]').hide();
            }
        }
    });

    function cardRadioInputChange(selectedCardId, cardPullNum) {
        checkedCards.set(Number(cardPullNum), selectedCardId);
        var isLimitedCard = limitedIds.includes(Number(selectedCardId));
        var cardTypeString = isLimitedCard == true ? 'Limited' : 'Standard';

        var radio = $('#' + selectedCardId + cardTypeString + '\\[' + cardPullNum + '\\]');
        var search = $('#cardNameSearch\\[' + cardPullNum + '\\]');
        $('#cardNameSearch\\[' + cardPullNum + '\\]').val($('#' + selectedCardId + cardTypeString + '\\[' + cardPullNum + '\\]')[0].labels[0].textContent);
        hideOtherCardsFromSearch(selectedCardId, cardPullNum);
        var preciseWishAttrName = "'cardPulls[" + cardPullNum + "].preciseWish'";
        var checkbox = $("[name=" + preciseWishAttrName + "]")[0];
        if (isMulti) {
            if (isLimitedCard) {
                checkbox.parentElement.style.display = "";
            }
            else {
                checkbox.parentElement.style.display = "none";
                checkbox.checked = false;
            }
        }
        else {
            checkbox.parentElement.style.display = "none";
            checkbox.checked = false;
        }
    }

    function searchForNameLimited(cardPullNum) {
        var cardNameSearch = "cardNameSearch[" + cardPullNum + "]";
        var listName = "cardsUL[" + cardPullNum + "]";
        searchForName(cardNameSearch, listName, limitedIds, "true");
    }
</script>
</body>
</html>